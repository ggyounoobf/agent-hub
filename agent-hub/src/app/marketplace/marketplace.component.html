<div class="marketplace-container">
  <!-- Header with User Stats -->
  <div class="marketplace-header">
    <div class="header-content">
      <h1 class="marketplace-title">AI Agent Marketplace</h1>
      <p class="marketplace-subtitle">Discover and deploy powerful AI agents</p>
    </div>
    <div class="stats-overview">
      <div class="stats-card">
        <div class="stats-grid">
          <div class="stat-item owned">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-number">{{ userAgentStats()?.owned_agents || 0 }}</span>
              <span class="stat-label">Owned Agents</span>
            </div>
          </div>
          <div class="stat-item pending">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-number">{{ userAgentStats()?.pending_requests || 0 }}</span>
              <span class="stat-label">Pending Requests</span>
            </div>
          </div>
          <div class="stat-item available">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-number">{{ filteredAgents().length }}</span>
              <span class="stat-label">Available Agents</span>
            </div>
          </div>
        </div>
        <button class="view-requests-btn" (click)="navigateToRequests()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          View All Requests
        </button>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="search-filters">
    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Search agents by name, tools, or capabilities..."
        [value]="searchQuery()"
        (input)="onSearchInput($event)"
      />
    </div>
    
    <!-- Filters -->
    <div class="filters-container">
      <div class="filter-group">
        <!-- Category filter -->
        @if (availableCategories().length > 0) {
          <select
            class="filter-select"
            [value]="selectedFilters().category"
            (change)="onFilterChange('category', $event)"
          >
            <option value="">All Categories</option>
            @for (category of availableCategories(); track category) {
              <option [value]="category">{{ category }}</option>
            }
          </select>
        }
        
        <!-- Status filter -->
        @if (availableStatuses().length > 0) {
          <select
            class="filter-select"
            [value]="selectedFilters().status"
            (change)="onFilterChange('status', $event)"
          >
            <option value="">All Statuses</option>
            @for (status of availableStatuses(); track status) {
              <option [value]="status">{{ getStatusText(status) }}</option>
            }
          </select>
        }
      </div>
      
      <!-- Clear filters button -->
      @if (selectedFilters().category || selectedFilters().status || searchQuery()) {
        <button class="clear-filters-btn" (click)="clearFilters()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
          </svg>
          <span>Clear</span>
        </button>
      }
    </div>
  </div>

  <!-- Agent Grid -->
  <div class="agents-grid">
    @for (agent of filteredAgents(); track agent.id) {
      <div class="agent-card" [class]="getStatusClass(getAgentProperty(agent, 'status'))">
        <div class="agent-header">
          <div class="agent-meta">
            <!-- Category -->
            @if (hasProperty(agent, 'category')) {
              <span class="agent-category">{{ getAgentProperty(agent, 'category') }}</span>
            }
            <!-- User-specific Status -->
            @if (agent.isOwned) {
              <span class="agent-status status-owned">
                Owned
              </span>
            } @else if (agent.isRequested) {
              <span class="agent-status status-requested">
                Requested
              </span>
            } @else {
              <span class="agent-status" [class]="getStatusClass(getAgentProperty(agent, 'status'))">
                {{ getStatusText(getAgentProperty(agent, 'status')) }}
              </span>
            }
          </div>
        </div>
        
        <div class="agent-content">
          <h3 class="agent-name">{{ formatAgentName(agent.name) }}</h3>
          <!-- Description -->
          @if (hasProperty(agent, 'description')) {
            <p class="agent-description">{{ getAgentProperty(agent, 'description') }}</p>
          }
          
          <!-- Capabilities -->
          @if (hasProperty(agent, 'capabilities') && getAgentProperty(agent, 'capabilities', []).length > 0) {
            <div class="agent-capabilities">
              @for (capability of getAgentProperty(agent, 'capabilities', []).slice(0, 3); track capability) {
                <span class="capability-tag">{{ capability }}</span>
              }
              @if (getAgentProperty(agent, 'capabilities', []).length > 3) {
                <span class="capability-more">+{{ getAgentProperty(agent, 'capabilities', []).length - 3 }}</span>
              }
            </div>
          }
          
          <!-- Tools count -->
          <div class="agent-tools-count">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>{{ getAgentProperty(agent, 'toolCount', 0) }} tools</span>
          </div>
        </div>
        
        <div class="agent-actions">
          @if (agent.isOwned) {
            <button class="action-btn primary" (click)="viewDetails(agent)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5,3 19,12 5,21"/>
              </svg>
              Launch
            </button>
          } @else if (agent.isRequested) {
            <button class="action-btn secondary" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              Requested
            </button>
          } @else if (getAgentProperty(agent, 'status') === 'admin-only') {
            <button class="action-btn secondary" (click)="requestAgent(agent)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              Request Access
            </button>
          } @else {
            <button class="action-btn secondary" (click)="requestAgent(agent)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
              Request
            </button>
          }
          
          <button class="action-btn outline" (click)="viewDetails(agent)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/>
            </svg>
          </button>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
        </div>
        <h3>No agents found</h3>
        <p>Try adjusting your search criteria or clear filters to see all available agents</p>
        @if (selectedFilters().category || selectedFilters().status || searchQuery()) {
          <button class="clear-filters-btn" (click)="clearFilters()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"/>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
            Clear All Filters
          </button>
        }
      </div>
    }
  </div>
</div>