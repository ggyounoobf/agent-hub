<div class="request-management">
  <!-- Header -->
  <div class="page-header">
    <div class="header-main">
      <div class="header-content">
        <div class="header-text">
          <div class="breadcrumb">
            <a routerLink="/marketplace" class="breadcrumb-link">Marketplace</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Access Requests</span>
          </div>
          <h1 class="page-title">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="title-icon">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <circle cx="12" cy="16" r="1"></circle>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Access Requests
          </h1>
          <p class="page-description">Track and manage your agent access requests</p>
        </div>
        <div class="header-actions">
          <a routerLink="/marketplace" class="browse-marketplace-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            Browse Marketplace
          </a>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-dashboard">
      <div class="stat-card total">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
        </div>
        <div class="stat-content">
          <span class="stat-number">{{ statusCounts().all }}</span>
          <span class="stat-label">Total Requests</span>
        </div>
      </div>

      <div class="stat-card pending">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
          </div>
        </div>
        <div class="stat-content">
          <span class="stat-number">{{ statusCounts().pending }}</span>
          <span class="stat-label">Pending</span>
        </div>
      </div>

      <div class="stat-card approved">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
          </div>
        </div>
        <div class="stat-content">
          <span class="stat-number">{{ statusCounts().approved }}</span>
          <span class="stat-label">Approved</span>
        </div>
      </div>

      <div class="stat-card denied">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
        </div>
        <div class="stat-content">
          <span class="stat-number">{{ statusCounts().rejected }}</span>
          <span class="stat-label">Rejected</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="main-content">
    <!-- Filters & Search -->
    <div class="filters-section">
      <div class="search-section">
        <div class="search-input-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Search by agent name or request ID..."
            [value]="searchQuery()"
            (input)="onSearchInput($event)"
          />
          @if (searchQuery()) {
            <button class="clear-search-btn" (click)="clearFilters()" title="Clear search">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          }
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">Filter by status:</label>
          <select
            class="status-filter"
            [value]="statusFilter()"
            (change)="onStatusFilterChange($event)"
          >
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>

          @if (statusFilter()) {
            <button class="clear-filter-btn" (click)="clearFilters()" title="Clear filters">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          }
        </div>
      </div>
    </div>

    <!-- Requests List -->
    <div class="requests-section">
      <div class="section-header">
        <div class="results-info">
          <h3 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Your Requests
          </h3>
          <span class="results-count">{{ filteredRequests().length }} {{ filteredRequests().length === 1 ? 'request' : 'requests' }}</span>
        </div>

      <div class="sort-controls">
        <label class="sort-label">Sort by:</label>
        <div class="sort-buttons">
          <button
            class="sort-btn"
            [class.active]="sortBy() === 'date'"
            (click)="onSortChange('date')"
          >
            Date
            @if (sortBy() === 'date') {
              <svg class="sort-icon" [class.desc]="sortOrder() === 'desc'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            }
          </button>
          <button
            class="sort-btn"
            [class.active]="sortBy() === 'tool'"
            (click)="onSortChange('tool')"
          >
            Agent
            @if (sortBy() === 'tool') {
              <svg class="sort-icon" [class.desc]="sortOrder() === 'desc'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            }
          </button>
          <button
            class="sort-btn"
            [class.active]="sortBy() === 'status'"
            (click)="onSortChange('status')"
          >
            Status
            @if (sortBy() === 'status') {
              <svg class="sort-icon" [class.desc]="sortOrder() === 'desc'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            }
          </button>
        </div>
      </div>
    </div>

    <div class="requests-grid">
      @if (loading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading your requests...</p>
        </div>
      } @else {
        @for (request of filteredRequests(); track request.id) {
          <div class="request-card" [attr.data-status]="request.status" [class.expanded]="isExpanded(request.id)">
            <!-- Minimalist Main Card -->
            <div class="card-main" (click)="toggleExpand(request.id)">
              <div class="card-header">
                <div class="tool-info">
                  <h4 class="tool-name">{{ request.agent_name }}</h4>
                  <span class="request-id">ID: {{ request.id }}</span>
                </div>
                <div class="request-meta">
                  <span class="status-badge" [class]="getStatusClass(request.status)">
                    @switch (request.status) {
                      @case ('approved') {
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                      }
                      @case ('rejected') {
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      }
                      @default {
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                      }
                    }
                    {{ getStatusText(request.status) }}
                  </span>
                  <span class="request-time">{{ getRelativeTime(request.created_at) }}</span>
                  <button class="expand-btn" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [class.rotated]="isExpanded(request.id)">
                      <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="card-summary">
                <div class="summary-details">
                  <span class="requested-at">Requested: {{ formatDate(request.created_at) }}</span>
                </div>
              </div>
            </div>

            <!-- Expandable Details -->
            <div class="card-details" [class.visible]="isExpanded(request.id)">
              <div class="details-content">
                <div class="details-grid">
                  <div class="detail-item">
                    <span class="detail-label">Request ID</span>
                    <span class="detail-value">{{ request.id }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Agent Name</span>
                    <span class="detail-value">{{ request.agent_name }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" [class]="getStatusClass(request.status)">
                      {{ getStatusText(request.status) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Requested</span>
                    <span class="detail-value">{{ formatDate(request.created_at) }}</span>
                  </div>
                  @if (request.updated_at) {
                    <div class="detail-item">
                      <span class="detail-label">Last Updated</span>
                      <span class="detail-value">{{ formatDate(request.updated_at) }}</span>
                    </div>
                  }
                  @if (request.justification) {
                    <div class="detail-item full-width">
                      <span class="detail-label">Justification</span>
                      <span class="detail-value">{{ request.justification }}</span>
                    </div>
                  }
                  @if (request.review_reason) {
                    <div class="detail-item full-width">
                      <span class="detail-label">Review Reason</span>
                      <span class="detail-value rejection-reason">{{ request.review_reason }}</span>
                    </div>
                  }
                </div>

                <div class="card-footer">
                  @if (request.status === 'approved') {
                    <div class="footer-content success">
                      <span class="footer-text">Access granted successfully</span>
                    </div>
                  } @else if (request.status === 'rejected') {
                    <div class="footer-content error">
                      <span class="footer-text">Request was rejected</span>
                      @if (request.review_reason) {
                        <span class="rejection-detail">Reason: {{ request.review_reason }}</span>
                      }
                    </div>
                  } @else {
                    <div class="footer-content pending">
                      <span class="footer-text">Awaiting review</span>
                    </div>
                  }
                  
                  <!-- Appeal button for rejected requests -->
                  @if (request.status === 'rejected') {
                    <div class="appeal-section">
                      <button 
                        class="appeal-btn" 
                        (click)="appealRequest(request.id); $event.stopPropagation()"
                        [disabled]="isAppealing()[request.id]"
                      >
                        @if (isAppealing()[request.id]) {
                          <div class="appeal-spinner"></div>
                        }
                        Request Again
                      </button>
                      <p class="appeal-help">Submit a new request for this agent</p>
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>
        } @empty {
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                <path d="M3 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                <path d="M12 21c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                <path d="M12 3c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
              </svg>
            </div>
            <h3>No requests found</h3>
            <p>You haven't submitted any access requests yet, or none match your current filters.</p>
            <div class="empty-actions">
              <button class="clear-filters-btn" (click)="clearFilters()">
                Clear Filters
              </button>
              <a routerLink="/marketplace" class="browse-tools-btn">
                Browse Agents
              </a>
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>
